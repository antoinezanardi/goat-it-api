name: ‚õµÔ∏è Deploy To Staging Workflow

on:
  push:
    branches:
      - "develop"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  upload-and-merge-images:
    name: Build and publish Docker images üê≥
    uses: ./.github/workflows/docker-build-and-push.yml
    with:
      registry-image: ${{ vars.DOCKER_REGISTRY_IMAGE }}
      platforms: '["linux/amd64","linux/arm64"]'
      tags: '["develop"]'
      environment-name: 'Docker Image Staging'
      environment-url: ${{ vars.DOCKER_HUB_STAGING_IMAGE_URL }}
    secrets:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}

  deploy-to-preproduction:
    name: Deploy to preproduction server üöÄ
    runs-on: ubuntu-latest
    needs: upload-and-merge-images
    timeout-minutes: 10
    steps:
      - name: Deploy to preproduction server üöÄ
        uses: ./.github/actions/deploy
        with:
          ssh-private-key: ${{ secrets.PREPRODUCTION_SERVER_SSH_PRIVATE_KEY }}
          ssh-user: ${{ secrets.PREPRODUCTION_SERVER_SSH_USER }}
          ssh-server-ip: ${{ secrets.PREPRODUCTION_SERVER_SSH_ADDRESS }}
          update-script-full-path: ${{ secrets.PREPRODUCTION_UPDATE_SCRIPT_FULL_PATH }}
