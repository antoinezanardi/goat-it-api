name: üöÄ Deploy To Production Workflow

on:
  release:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  upload-and-merge-images:
    name: Build and publish Docker images üê≥
    uses: ./.github/workflows/docker-build-and-push.yml
    with:
      registry-image: ${{ vars.DOCKER_REGISTRY_IMAGE }}
      platforms: '["linux/amd64","linux/arm64"]'
      tags: '["${{ github.event.release.tag_name }}","latest"]'
      environment-name: 'Docker Image Production'
      environment-url: ${{ vars.DOCKER_HUB_PRODUCTION_IMAGE_URL }}
    secrets:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}

  deploy-to-production:
    name: Deploy to production server üöÄ
    runs-on: ubuntu-latest
    needs: upload-and-merge-images
    timeout-minutes: 10
    steps:
      - name: Deploy to production server üöÄ
        uses: ./.github/actions/deploy
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SERVER_SSH_PRIVATE_KEY }}
          ssh-user: ${{ secrets.PRODUCTION_SERVER_SSH_USER }}
          ssh-server-ip: ${{ secrets.PRODUCTION_SERVER_SSH_ADDRESS }}
          update-script-full-path: ${{ secrets.PRODUCTION_UPDATE_SCRIPT_FULL_PATH }}
