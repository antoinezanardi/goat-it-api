name: ğŸš€ Deploy To Production Workflow

on:
  release:
    types: [ created ]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  upload-to-docker-hub:
    name: Upload image with develop tag to Docker Hub ğŸ³
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
        tag:
          - ${{ github.event.release.tag_name }}
          - latest
    steps:
      - name: Checkout GitHub repository ğŸ“¡
        uses: actions/checkout@v4

      - name: Upload to Docker Hub ğŸ³
        uses: ./.github/actions/upload-to-docker-hub
        with:
          docker-hub-username: ${{ secrets.DOCKER_HUB_USERNAME }}
          docker-hub-password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          registry-image: ${{ vars.DOCKER_REGISTRY_IMAGE }}
          platform: ${{ matrix.platform }}
          tag: ${{ matrix.tag }}

  merge-images-into-manifest-list:
    name: Merge images into a manifest list ğŸ—‚ï¸
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag:
          - ${{ github.event.release.tag_name }}
          - latest
    needs: upload-to-docker-hub
    steps:
      - name: Checkout GitHub repository ğŸ“¡
        uses: actions/checkout@v4

      - name: Merge images into a manifest list ğŸ—‚ï¸
        uses: ./.github/actions/merge-images-into-manifest-list
        with:
          docker-hub-username: ${{ secrets.DOCKER_HUB_USERNAME }}
          docker-hub-password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          registry-image: ${{ env.REGISTRY_IMAGE }}
          tag: ${{ matrix.tag }}
